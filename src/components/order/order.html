<div class="orders-dashboard">

  <header class="dashboard-header">
    <div class="header-info">
      <button class="btn-back" (click)="goBack()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
      </button>
      <h1>Pedidos & Encomendas</h1>
      <div class="filters">
        <button [class.active]="filterStatus === 'all'" (click)="filterStatus = 'all'">Todos</button>
        <button [class.active]="filterStatus === 'pending'" (click)="filterStatus = 'pending'">Para Enviar</button>
        <button [class.active]="filterStatus === 'delivered'"
          (click)="filterStatus = 'delivered'">Enviados/Finalizados</button>
      </div>
    </div>

    <button class="btn-new-order" (click)="openNewOrder()">
      <span class="plus">+</span> NOVO PEDIDO
    </button>
  </header>

  <!-- ERROR FEEDBACK (TOAST) -->
  <div class="toast error" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <!-- SUCCESS FEEDBACK (TOAST) -->
  <div class="toast success" *ngIf="successMessage">
    {{ successMessage }}
  </div>

  <!-- LOADING STATE -->
  <ng-template #loading>
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando pedidos...</p>
    </div>
  </ng-template>

  <!-- MAIN GRID with Async Pipe Subscription -->
  <div class="kanban-grid" *ngIf="filteredOrders$ | async as orders; else loading">

    <!-- Empty State -->
    <div class="empty-state" *ngIf="orders.length === 0">
      <p>Nenhum pedido encontrado.</p>
    </div>

    <div *ngFor="let order of orders; trackBy: trackByOrder" class="order-card" [ngClass]="order.status">

      <!-- HEADER DO CARD: Status + ID + Tempo -->
      <div class="card-header-styled">
        <div class="status-badge">
          {{ translateStatus(order.status) }}
        </div>
        <div class="meta-info">
          <span class="order-id">{{ getOrderDate(order.createdAt) | date:'dd/MM' }}</span>
          <span class="time-badge">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            {{ getOrderDate(order.createdAt) | date:'HH:mm' }}
          </span>
        </div>
      </div>

      <div class="card-body-styled">
        <h3 class="customer-name">{{ order.customerName }}</h3>

        <!-- DELIVERY INFO -->
        <div class="delivery-info-styled" *ngIf="order.deliveryType === 'delivery'">
          <div class="icon-box delivery">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="3" width="15" height="13"></rect>
              <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
              <circle cx="5.5" cy="18.5" r="2.5"></circle>
              <circle cx="18.5" cy="18.5" r="2.5"></circle>
            </svg>
          </div>
          <div class="info-content">
            <strong>Entrega</strong>
            <span class="address" title="{{ order.address }}">{{ order.address }}</span>
          </div>
        </div>

        <div class="delivery-info-styled pickup" *ngIf="order.deliveryType === 'pickup'">
          <div class="icon-box pickup">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </div>
          <div class="info-content">
            <strong>Retirada no Balc√£o</strong>
          </div>
        </div>

        <!-- ITEMS PREVIEW -->
        <ul class="items-list-styled">
          <li *ngFor="let item of order.items.slice(0, 3)">
            <span class="qty">{{ item.quantity }}x</span>
            <span class="prod-name">{{ item.productName }}</span>
          </li>
          <li *ngIf="order.items.length > 3" class="more-items">
            + {{ order.items.length - 3 }} itens...
          </li>
        </ul>
      </div>

      <!-- ACTIONS FOOTER -->
      <div class="card-footer-styled">
        <div class="main-actions">
          <!-- Bot√£o Principal de A√ß√£o -->
          <button *ngIf="getNextActionLabel(order.status)" class="btn-primary-action" [disabled]="isProcessingAction"
            (click)="advanceStatus(order)">
            <span>{{ getNextActionLabel(order.status) }}</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>

        <div class="secondary-actions">
          <button class="btn-icon view" (click)="viewDetails(order)" title="Ver Detalhes">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>

          <button *ngIf="order.status !== 'finished' && order.status !== 'canceled'" class="btn-icon cancel"
            [disabled]="isProcessingAction" (click)="cancelAction(order)" title="Cancelar Pedido">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- OVERLAY NOVO PEDIDO -->
  <div class="overlay-panel" *ngIf="isNewOrderOpen">
    <div class="panel-content">
      <div class="panel-header">
        <h2>Nova Encomenda</h2>
        <button class="btn-close" (click)="closeNewOrder()">‚úï</button>
      </div>

      <div class="panel-body">

        <div class="form-section">
          <h3>Dados do Cliente</h3>
          <div class="input-group">
            <input type="text" [(ngModel)]="customerName" placeholder="Nome do Cliente *" autofocus>
            <input type="text" [(ngModel)]="customerPhone" placeholder="Telefone">
          </div>

          <div class="toggle-delivery">
            <button [class.active]="deliveryType === 'pickup'" (click)="setDeliveryType('pickup')">Retirada</button>
            <button [class.active]="deliveryType === 'delivery'" (click)="setDeliveryType('delivery')">Entrega</button>
          </div>

          <input *ngIf="deliveryType === 'delivery'" type="text" [(ngModel)]="address"
            placeholder="Endere√ßo de Entrega *" class="full-width">

          <div class="freight-row" *ngIf="deliveryType === 'delivery'">
            <label>Frete/Taxa R$:</label>
            <input type="number" [(ngModel)]="shippingCost" min="0">
          </div>

          <div class="obs-row">
            <textarea [(ngModel)]="observations" placeholder="Observa√ß√µes (Opcional)" rows="2"></textarea>
          </div>
        </div>

        <div class="products-section">
          <h3>Adicionar Produtos</h3>
          <div class="mini-product-grid">
            <div *ngFor="let p of products$ | async" class="mini-card" (click)="addToCart(p)">
              <span>{{ p.title }}</span>
              <div class="price">R$ {{ p.sellPrice }}</div>
            </div>
            <div *ngIf="(products$ | async)?.length === 0" class="no-products">
              Carregando produtos...
            </div>
          </div>
        </div>
      </div>

      <div class="panel-footer">
        <div class="cart-summary">
          <h4>Itens do Pedido:</h4>
          <div class="cart-items-list">
            <span *ngFor="let item of cart" class="cart-tag">
              {{ item.quantity }}x {{ item.productName }}
              <a (click)="removeFromCart(item)" class="remove-btn">x</a>
            </span>
          </div>
          <span *ngIf="cart.length === 0" class="empty-msg">Nenhum item adicionado</span>
        </div>

        <div class="footer-actions">
          <div class="total-badge">Total: R$ {{ finalTotal | number:'1.2-2' }}</div>
          <button class="btn-save-order" (click)="saveOrder()" [disabled]="cart.length === 0 || isProcessingAction">
            <span *ngIf="!isProcessingAction">CONFIRMAR PEDIDO</span>
            <span *ngIf="isProcessingAction">‚è≥ Salvando...</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL PAGAMENTO -->
  <div class="modal-backdrop" *ngIf="isPaymentModalOpen">
    <div class="modal-content">
      <h3>Finalizar Pedido</h3>
      <p>Confirmar recebimento e finalizar?</p>

      <div class="payment-options">
        <label>
          <input type="radio" name="payment" [value]="'dinheiro'" [(ngModel)]="selectedPaymentMethod"> Dinheiro
        </label>
        <label>
          <input type="radio" name="payment" [value]="'pix'" [(ngModel)]="selectedPaymentMethod"> PIX
        </label>
        <!-- Adicione mais se tiver no Enum -->
      </div>

      <div class="modal-actions">
        <button (click)="closePaymentModal()" [disabled]="isProcessingAction">Cancelar</button>
        <button class="btn-confirm" (click)="confirmPayment()" [disabled]="isProcessingAction">
          {{ isProcessingAction ? 'Processando...' : 'Confirmar Pagamento' }}
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL DE CONFIRMA√á√ÉO GEN√âRICO -->
  <div class="modal-backdrop" *ngIf="isConfirmModalOpen">
    <div class="modal-content confirm-modal">
      <h3>Confirma√ß√£o</h3>
      <p>{{ confirmMessage }}</p>

      <div class="modal-actions">
        <button class="btn-cancel" (click)="closeConfirmModal()" [disabled]="isProcessingAction">N√£o</button>
        <button class="btn-confirm" (click)="onConfirmYes()" [disabled]="isProcessingAction">
          {{ isProcessingAction ? 'Processando...' : 'Sim, Confirmar' }}
        </button>
      </div>
    </div>
  </div>

</div>

<!-- MODAL DETALHES -->
<div class="modal-backdrop" *ngIf="isDetailsModalOpen && selectedOrderDetails">
  <div class="modal-content details-modal">
    <div class="modal-header">
      <h3>Detalhes do Pedido #{{ selectedOrderDetails.createdAt.toMillis() | date:'mmss' }}</h3>
      <button class="btn-close-modal" (click)="closeDetails()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="modal-body">

      <!-- HEADER DO DETALHE: NOME E STATUS -->
      <div class="detail-header-section">
        <div class="customer-info">
          <h2>{{ selectedOrderDetails.customerName }}</h2>
          <span class="phone" *ngIf="selectedOrderDetails.customerPhone">{{ selectedOrderDetails.customerPhone }}</span>
        </div>
        <div class="status-tag" [ngClass]="selectedOrderDetails.status">
          {{ translateStatus(selectedOrderDetails.status) }}
        </div>
      </div>

      <!-- TIPO DE ENTREGA -->
      <div class="detail-delivery-section">
        <div class="delivery-badge" [class.pickup]="selectedOrderDetails.deliveryType === 'pickup'">
          <span *ngIf="selectedOrderDetails.deliveryType === 'delivery'">üõµ Entrega</span>
          <span *ngIf="selectedOrderDetails.deliveryType === 'pickup'">üè¢ Retirada</span>
        </div>
        <p class="address-text" *ngIf="selectedOrderDetails.address">
          {{ selectedOrderDetails.address }}
        </p>
      </div>

      <!-- LISTA DE ITENS -->
      <div class="detail-items-section">
        <h4>Itens do Pedido</h4>
        <ul class="detail-items-list">
          <li *ngFor="let item of selectedOrderDetails.items">
            <div class="item-line">
              <span class="item-qty">{{ item.quantity }}x</span>
              <span class="item-name">{{ item.productName }}</span>
              <span class="item-price">R$ {{ item.priceAtSale * item.quantity | number:'1.2-2' }}</span>
            </div>
          </li>
        </ul>
      </div>

      <!-- TOTAIS -->
      <div class="detail-totals">
        <div class="total-row" *ngIf="selectedOrderDetails.shippingCost > 0">
          <span>Taxa de Entrega:</span>
          <span>R$ {{ selectedOrderDetails.shippingCost | number:'1.2-2' }}</span>
        </div>
        <div class="total-row final">
          <span>Total:</span>
          <span>R$ {{ selectedOrderDetails.total | number:'1.2-2' }}</span>
        </div>
      </div>

      <!-- OBS -->
      <div class="detail-obs" *ngIf="selectedOrderDetails.observations">
        <label>Observa√ß√µes:</label>
        <p>{{ selectedOrderDetails.observations }}</p>
      </div>

    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeDetails()">Fechar</button>
    </div>
  </div>
</div>